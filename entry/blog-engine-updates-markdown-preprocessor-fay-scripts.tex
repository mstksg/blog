\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
    \usepackage{xltxtra,xunicode}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Mapping=tex-text,Scale=MatchLowercase}
  \newcommand{\euro}{â‚¬}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{\usepackage{microtype}}{}
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\newenvironment{Shaded}{}{}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.56,0.13,0.00}{{#1}}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.25,0.63,0.44}{{#1}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.53,0.00,0.00}{{#1}}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.25,0.44,0.63}{{#1}}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.73,0.40,0.53}{{#1}}}
\newcommand{\ImportTok}[1]{{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textit{{#1}}}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.73,0.13,0.13}{\textit{{#1}}}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{{#1}}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.02,0.16,0.49}{{#1}}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.10,0.09,0.49}{{#1}}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.44,0.13}{\textbf{{#1}}}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.40,0.40,0.40}{{#1}}}
\newcommand{\BuiltInTok}[1]{{#1}}
\newcommand{\ExtensionTok}[1]{{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.74,0.48,0.00}{{#1}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.49,0.56,0.16}{{#1}}}
\newcommand{\RegionMarkerTok}[1]{{#1}}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.38,0.63,0.69}{\textbf{\textit{{#1}}}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{1.00,0.00,0.00}{\textbf{{#1}}}}
\newcommand{\NormalTok}[1]{{#1}}
\ifxetex
  \usepackage[setpagesize=false, % page size defined by xetex
              unicode=false, % unicode breaks when used with xetex
              xetex]{hyperref}
\else
  \usepackage[unicode=true]{hyperref}
\fi
\hypersetup{breaklinks=true,
            bookmarks=true,
            pdfauthor={Justin Le},
            pdftitle={Blog engine updates: Markdown Preprocessor \& Fay Scripts},
            colorlinks=true,
            citecolor=blue,
            urlcolor=blue,
            linkcolor=magenta,
            pdfborder={0 0 0}}
\urlstyle{same}  % don't use monospace font for urls
% Make links footnotes instead of hotlinks:
\renewcommand{\href}[2]{#2\footnote{\url{#1}}}
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\setcounter{secnumdepth}{0}

\title{Blog engine updates: Markdown Preprocessor \& Fay Scripts}
\author{Justin Le}
\date{January 27, 2014}

\begin{document}
\maketitle

\emph{Originally posted on
\textbf{\href{http://home.jle0.com:4111/entry/blog-engine-updates-markdown-preprocessor-fay-scripts.html}{in
Code}}.}

I spent some time over the past week writing a preprocessor for the
entry copy markdowns and getting Fay to deploy some simple scripts.

The need for a preprocessor was sparked by a post I'm writing that sort
of necessitated the features. I write
\href{https://github.com/mstksg/inCode/tree/master/copy/entries}{all of
my posts} in markdown, and it all integrated well with the preprocessor.
In addition I needed some javascript scripting to make the preprocessor
actions worthwhile, so I buckled down and wrestled with getting Fay to
work in a production environment. So I guess this post is to show off
some new features of the blog engine?

Here it is in action:

\begin{verbatim}
> !!!monad-plus/WolfGoatCabbage.hs "makeMove ::" "moveLegal ::" wolf-goat-cabbage
\end{verbatim}

yields:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{-- source: https://github.com/mstksg/blog/tree/develop/code-samples/monad-plus/WolfGoatCabbage.hs#L37-58}
\CommentTok{-- interactive: https://www.fpcomplete.com/user/jle/wolf-goat-cabbage}
\OtherTok{makeMove ::} \DataTypeTok{Plan} \OtherTok{->} \NormalTok{[}\DataTypeTok{Plan}\NormalTok{]}
\NormalTok{makeMove p }\FunctionTok{=} \KeywordTok{do}
    \NormalTok{next }\OtherTok{<-} \DataTypeTok{MoveThe} \FunctionTok{<$>} \NormalTok{[}\DataTypeTok{Farmer} \FunctionTok{..}\NormalTok{]}
    \NormalTok{guard       }\FunctionTok{$} \NormalTok{moveLegal p next}
    \NormalTok{guard }\FunctionTok{.} \NormalTok{not }\FunctionTok{$} \NormalTok{moveRedundant p next}
    \KeywordTok{let}
        \NormalTok{p' }\FunctionTok{=} \NormalTok{p }\FunctionTok{++} \NormalTok{[next]}
    \NormalTok{guard }\FunctionTok{$} \NormalTok{safePlan p'}
    \NormalTok{return p'}

\OtherTok{moveLegal ::} \DataTypeTok{Plan} \OtherTok{->} \DataTypeTok{Move} \OtherTok{->} \DataTypeTok{Bool}
\NormalTok{moveLegal p (}\DataTypeTok{MoveThe} \DataTypeTok{Farmer}\NormalTok{)  }\FunctionTok{=} \DataTypeTok{True}
\NormalTok{moveLegal p (}\DataTypeTok{MoveThe} \NormalTok{c)       }\FunctionTok{=} \NormalTok{positionOf p c }\FunctionTok{==} \NormalTok{positionOf p }\DataTypeTok{Farmer}
\end{Highlighting}
\end{Shaded}

(Mouse over or click them to see the full effect :) )

\section{Code quoting/linking
preprocessor}\label{code-quotinglinking-preprocessor}

So I find myself writing a lot of sample code for my posts, and then
later copying and pasting them over to the
\href{https://github.com/mstksg/inCode/tree/master/code-samples}{code-samples}
directory on the github in order to allow people to download
them\ldots{}and then later awkwardly putting a link saying ``download
these here!'' afterwards and taking up space. Also linking to a live
\href{https://www.fpcomplete.com/}{FPComplete} version is a bit awkward
too, right after the block.

I was rather inspired by the interface on the code blocks for
\href{http://weblog.luite.com/wordpress/?p=127}{luite's blog}, where
every relevant code block has a little link box on the top right hand
corner linking to the source and a working/running example.

So I wrote a Haskell preprocessor to take in a specification of a code
file and a what blocks in the code file to load, and then load it into
the markdown file before it is processed by pandoc.

The syntax is:

\begin{verbatim}
> !!!path/to/code "keyword" "limited"n live_link
\end{verbatim}

Where ``keyword'' is the text in the line to match for, \texttt{n} is
the number of lines after the keyword to display (if left off, it takes
the next ``block'', or the next continuous piece of code before a new
non-indented line), and \texttt{live\_link} is a link to the
live/interactive version on FPComplete.

\subsection{Reflections}\label{reflections}

So\ldots{}writing the parser for the syntax specification was pretty
easy due to parsec and parser combinators:

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{-- source: https://github.com/mstksg/blog/tree/develop/code-samples/source/EntryPP.hs#L32-127}
\KeywordTok{data} \DataTypeTok{SampleSpec} \FunctionTok{=} \DataTypeTok{SampleSpec}  \NormalTok{\{}\OtherTok{ sSpecFile       ::} \NormalTok{FilePath}
                              \NormalTok{, _}\OtherTok{sSpecLive      ::} \DataTypeTok{Maybe} \DataTypeTok{String}
                              \NormalTok{, _}\OtherTok{sSpecKeywords  ::} \NormalTok{[(}\DataTypeTok{String}\NormalTok{,}\DataTypeTok{Maybe} \DataTypeTok{Int}\NormalTok{)]}
                              \NormalTok{\} }\KeywordTok{deriving} \NormalTok{(}\DataTypeTok{Show}\NormalTok{)}

\OtherTok{sampleSpec ::} \DataTypeTok{Parser} \DataTypeTok{SampleSpec}
\NormalTok{sampleSpec }\FunctionTok{=} \KeywordTok{do}
    \NormalTok{filePath }\OtherTok{<-} \NormalTok{noSpaces }\FunctionTok{<?>} \StringTok{"sample filePath"}
    \NormalTok{spaces}
    \NormalTok{keywords }\OtherTok{<-} \NormalTok{many }\FunctionTok{$} \KeywordTok{do}
      \NormalTok{keyword }\OtherTok{<-} \NormalTok{char }\CharTok{'"'} \FunctionTok{*>} \NormalTok{manyTill anyChar (char }\CharTok{'"'}\NormalTok{) }\FunctionTok{<?>} \StringTok{"keyword"}
      \NormalTok{keylimit }\OtherTok{<-} \NormalTok{optionMaybe (read }\FunctionTok{<$>} \NormalTok{many1 digit }\FunctionTok{<?>} \StringTok{"keyword limit"}\NormalTok{)}
      \NormalTok{spaces}
      \NormalTok{return (keyword,keylimit)}

    \NormalTok{live }\OtherTok{<-} \NormalTok{optionMaybe noSpaces }\FunctionTok{<?>} \StringTok{"live url"}
    \KeywordTok{let}
      \NormalTok{live' }\FunctionTok{=} \NormalTok{mfilter (not }\FunctionTok{.} \NormalTok{null) live}

    \NormalTok{return }\FunctionTok{$} \DataTypeTok{SampleSpec} \NormalTok{filePath live' keywords}
  \KeywordTok{where}
    \NormalTok{noSpaces }\FunctionTok{=} \NormalTok{manyTill anyChar (space }\FunctionTok{<|>} \CharTok{' '} \FunctionTok{<$} \NormalTok{eof)}
\end{Highlighting}
\end{Shaded}

The code to actually find the right code block to paste was complicated
and horrifying at first, but after I sat down and really sorted out the
logic, it wasn't too bad. Still, it isn't the cleanest code in the world
and I wonder how I could have made it better, either with a Haskell
library or even another language.

This all left two little comment lines before the source code insert
with the link to the source and interactive versions.

All that was left was a front-end script to get the comments and turn
them into floating divs.

\section{Fay}\label{fay}

Ah okay, here was the fun part.

Fay is actually pretty fun to use. And while it was perhaps complete
overkill to use the entire Fay runtime and build system for just a
simple script, but I was pretty inspired by
\href{http://ocharles.org.uk/blog/posts/2013-12-23-24-days-of-hackage-fay.html}{ocharles's
post on fay} and I thought this would be a good time to get to learn it.

So there was a lot of cognitive friction going in, and trying to really
get in the groove took a few days. There was also a rather unhelpful
error message involving the ffi that I was able to bring up to the
maintainers and be a part of getting the fix working.

I converted as much of my current scripts as I could to fay. There was
one that I couldn't --- a function call to a library that required a
javascript object of function callbacks, and I couldn't really get that
to work cleanly and I decided it wasn't worth the effort for now ---
maybe another day. If anything I could re-write the entire library (a
Table of Contents generator) myself some day.

\subsection{Reflections}\label{reflections-1}

\subsubsection{fay-jquery}\label{fay-jquery}

Here is a characteristic example of fay code with fay-jquery (0.6.0.2):

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{-- source: https://github.com/mstksg/blog/tree/develop/code-samples/source/entry.hs#L45-54}
\OtherTok{appendTopLinks ::} \DataTypeTok{Fay} \NormalTok{()}
\NormalTok{appendTopLinks }\FunctionTok{=} \KeywordTok{do}
  \NormalTok{mainContent }\OtherTok{<-} \NormalTok{select }\StringTok{".main-content"}
  \NormalTok{headings }\OtherTok{<-} \NormalTok{childrenMatching }\StringTok{"h2,h3,h4,h5"} \NormalTok{mainContent}
  \NormalTok{J.append topLink headings}
  \NormalTok{topLinks }\OtherTok{<-} \NormalTok{select }\StringTok{".top-link"}
  \NormalTok{click (scrollTo }\DecValTok{400}\NormalTok{) topLinks}
  \NormalTok{return ()}
  \KeywordTok{where}
    \NormalTok{topLink }\FunctionTok{=} \StringTok{"<a href='#title' class='top-link'>top</a>"}
\end{Highlighting}
\end{Shaded}

As you can see, some of the method calls in fay-jquery seem a bit
backwards\ldots{}I keep on resisting the urge to write things like

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{container }\OtherTok{`append`} \NormalTok{contained}
\NormalTok{container }\OtherTok{`childrenMatching`} \StringTok{".contained"}
\end{Highlighting}
\end{Shaded}

Which matches the JQuery calling model:

\begin{Shaded}
\begin{Highlighting}[]
\VariableTok{container}\NormalTok{.}\AttributeTok{append}\NormalTok{(contained)}\OperatorTok{;}
\VariableTok{container}\NormalTok{.}\AttributeTok{children}\NormalTok{(}\StringTok{'.contained'}\NormalTok{)}\OperatorTok{;}
\end{Highlighting}
\end{Shaded}

But alas, the decision was made otherwise. I guess it is more Haskell-y
to be able to play with partial application and do something like

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{let}
  \NormalTok{appendIt }\FunctionTok{=} \NormalTok{append container}
\KeywordTok{in}
  \NormalTok{appendIt contained1}
  \NormalTok{appendIt contained2}
  \NormalTok{appendIt contained3}
\end{Highlighting}
\end{Shaded}

So I guess that's okay.

However, something I was less understanding of was the ordering for
event binding, which needed the handlers \emph{before} the object being
binded.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{-- source: https://github.com/mstksg/blog/tree/develop/code-samples/source/entry.hs#L112-119}
\OtherTok{processCodeBlocks ::} \DataTypeTok{Fay} \NormalTok{()}
\NormalTok{processCodeBlocks }\FunctionTok{=} \KeywordTok{do}
  \NormalTok{blocks }\OtherTok{<-} \NormalTok{select }\StringTok{".main-content pre.sourceCode"}
  \NormalTok{flip each blocks }\FunctionTok{$} \NormalTok{\textbackslash{}_ el }\OtherTok{->} \KeywordTok{do}
    \NormalTok{elJ }\OtherTok{<-} \NormalTok{select el}
    \NormalTok{processBlock elJ}
    \NormalTok{return }\DataTypeTok{True}
  \NormalTok{return ()}
\end{Highlighting}
\end{Shaded}

This one kind of bucks the convention that methods like \texttt{append}
maintain\ldots{}and also needs those annoying \texttt{flips} to have
easy anonymous callbacks. I don't want to have to name every little
thing. Oh well. Maybe there is a good justification here? I just don't
see it. But then again, there is a reason why we have both \texttt{mapM}
and \texttt{forM} in base.

\subsubsection{Deploying fay}\label{deploying-fay}

Deploying fay ain't all too bad. I
\href{http://blog.jle.im/entry/deploying-medium-to-large-haskell-apps-to-heroku}{deploy
binaries}, however, so I was unable to ever process fay on my
limited-access production server because it requires \texttt{ghc-pkg}
(installed under \texttt{/usr/local/bin}) among other things\ldots{}I
probably could have gotten this to work, but I did not have the proper
skills. You also need to provide the binaries and headers in
\texttt{share} for all of your fay libraries in order to use them when
compiling to javascript. So while this isn't so bad if you have the
whole Haskell Platform and are compiling on your production server, I
had to pre-compile my fay ``binaries'' before pushing\ldots{}just like I
have to pre-compile my regular binaries, interestingly enough.

Of course, the fay javascript files were a bit larger than the normal
javascript ones. Not too significantly, though, only about 80x. This
actually puts them however at around the size of my image files
(\textasciitilde{}100KB)\ldots{}this is slightly worrisome, but I don't
really stress too much about one image, so I guess I shouldn't stress
too much about this either. Not ideal, but what else could I expect?

\section{Future stuff}\label{future-stuff}

Hopefully I'm able to make
\href{http://blog.jle.im/source/code-samples/source/entry_toc.js\#L4-21}{that
javascript call} on fay one day, without having to rewrite the entire
library in Fay (although it might be a fun exercise).

If anyone knows how I can do this, I'd really appreciate any help!

I'd also in the future like to make my preprocessor a bit more robust
and take more languages. But\ldots{}I probably wouldn't do this until
the need actually arises :)

\end{document}
